<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Technician Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#1a1024;color:#f0e6ff}
    header{padding:16px;background:#2c1952;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;text-align:left;vertical-align:top}
    tr:not(:first-child){border-top:1px solid rgba(255,255,255,0.08)}
    .status{font-weight:600;padding:6px 10px;border-radius:6px;display:inline-block}
    .status.notpicked{background:#6b1f1f;color:#ffecec}
    .status.preparing{background:#6b4d1f;color:#fff8e0}
    .status.ready{background:#1e4f2d;color:#ffffff;animation:pulse 1.8s infinite;box-shadow:0 0 8px rgba(0,255,0,0.4);}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.05)}}
    button{padding:6px 10px;border-radius:6px;border:0;cursor:pointer;font-weight:600}
    .btn-preparing{background:#f1c232;color:#222}
    .btn-ready{background:#3cba54;color:#fff}
    .btn-clear{background:#777;color:#fff}
    .asset-pill{display:inline-block;border-radius:6px;padding:4px 8px;margin:2px;font-weight:600;color:#f0e6ff}
    .asset-video{background-color:rgba(128,0,128,0.25)}
    .asset-sound{background-color:rgba(255,0,0,0.25)}
    .asset-lighting{background-color:rgba(255,235,59,0.35);color:#fff}
    .asset-grip,.asset-uncategorised,.asset-uncategorized{background-color:rgba(128,128,128,0.25)}
  </style>
</head>
<body>
  <header>
    <h1>Technician Dashboard</h1>
    <div id="clock" style="opacity:.9;font-size:13px">Loading...</div>
  </header>

  <main style="padding:16px">
    <div style="font-size:12px;opacity:0.8;margin-bottom:8px;">
      <span class="asset-pill asset-video">Video</span>
      <span class="asset-pill asset-sound">Sound</span>
      <span class="asset-pill asset-lighting">Lighting</span>
      <span class="asset-pill asset-grip">Grip / Uncategorised</span>
    </div>
    <div id="tableWrap"></div>
  </main>

  <script>
    const tableWrap=document.getElementById('tableWrap');
    const clockEl=document.getElementById('clock');
    function updateClock(){clockEl.textContent=new Date().toLocaleString();}
    setInterval(updateClock,1000);updateClock();

    function formatTime(dt){if(!dt)return'';const d=new Date(dt);return isNaN(d)?dt:d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
    function renderAssets(assets){return assets.map(a=>`<span class="asset-pill asset-${a.category.toLowerCase()}">${a.name}</span>`).join('');}

    async function updateStatus(key,status){
      try{
        await fetch('/api/update-status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,status})});
        await fetchBookings();
      }catch(err){console.error('Update failed',err);}
    }

    async function fetchBookings(){
      try{
        const resp=await fetch('/api/bookings');
        const data=await resp.json();
        const bookings=data.success&&Array.isArray(data.bookings)?data.bookings:[];
        bookings.sort((a,b)=>new Date(a.startdatetime)-new Date(b.startdatetime));
        renderTable(bookings);
      }catch(err){console.error('Fetch failed',err);}
    }

    function renderTable(bookings){
      let html='<table><thead><tr><th>Time</th><th>Name</th><th>Status</th><th>Equipment</th><th>Actions</th></tr></thead><tbody>';
      if(!bookings.length){html+='<tr><td colspan="5">No bookings for today.</td></tr>';}
      else{
        for(const b of bookings){
          const time=formatTime(b.startdatetime);
          const stClass=b.status.toLowerCase().replace(/\s+/g,'');
          html+=`<tr>
            <td>${time}</td>
            <td>${b.username}</td>
            <td><span class="status ${stClass}">${b.status}</span></td>
            <td>${renderAssets(b.assets)}</td>
            <td>
              ${b.status==='Not Picked'?`<button class="btn-preparing" onclick="updateStatus('${b._groupKey}','preparing')">Preparing</button>`:''}
              ${b.status==='Preparing'?`<button class="btn-ready" onclick="updateStatus('${b._groupKey}','ready')">Ready</button>`:''}
              <button class="btn-clear" onclick="updateStatus('${b._groupKey}','clear')">Clear</button>
            </td>
          </tr>`;
        }
      }
      html+='</tbody></table>';tableWrap.innerHTML=html;
    }

    setInterval(fetchBookings,5000);
    (async function init(){await fetchBookings();})();
  </script>
</body>
</html>
